<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Johnny Bravo Chat</title>
    <style>
      body {
        font-family: sans-serif;
        background: #111;
        color: #eee;
        padding: 20px;
      }
      input,
      button {
        padding: 10px;
        font-size: 16px;
      }
      #response {
        margin-top: 20px;
        font-size: 18px;
        color: #ffd166;
      }
    </style>
  </head>
  <body>
    <h2>ðŸ’¬ Talk to Johnny Bravo</h2>
    <input id="userInput" type="text" placeholder="Say something..." />
    <button id="sendBtn">Send</button>
    <p id="response">Johnny will respond here...</p>

    <script>
      const btn = document.getElementById("sendBtn");
      const input = document.getElementById("userInput");
      const resp = document.getElementById("response");

      // âœ… Add timeout & fetch safety
      async function fetchWithTimeout(url, options = {}, timeout = 10000) {
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeout);
        try {
          const response = await fetch(url, {
            ...options,
            signal: controller.signal,
          });
          clearTimeout(id);
          return response;
        } catch (err) {
          throw new Error("Network request failed or timed out");
        }
      }

      const API_BASE_URL = "http://localhost:8080";
      const replies = [
        "I'm bored!",
        "Do you like my hair?",
        "You're boring!",
        "Come back when you're older!",
      ];

      const longerTextReplies = [
        "You talk too much, little boy!",
        "I like flirty men, not talkative little boys",
      ];

      const cueReplies = ["Hmm...", " okay..."];

      const random = Math.floor(Math.random() * longerTextReplies.length);

      async function sendMessage() {
        const text = input.value.trim();

        // âœ… Validate input
        if (!text || text.length > 300) {
          resp.textContent = longerTextReplies[random];
          alert(longerTextReplies[random]);
          return;
        }

        // âœ… UI feedback
        resp.textContent = cueReplies[random];
        btn.disabled = true;

        try {
          const res = await fetchWithTimeout(`${API_BASE_URL}/chat`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: text }),
          });

          // âœ… Check status
          if (!res.ok) {
            const errMsg = replies[random];
            resp.textContent = errMsg;
            throw new Error(errMsg);
          }

          // âœ… Parse safely
          const data = await res
            .json()
            .catch(() => ({ reply: replies[random] }));
          resp.textContent = data.reply || replies[random];
        } catch (e) {
          console.error(e);
          resp.textContent = replies[random];
        } finally {
          // âœ… Always re-enable and clear
          btn.disabled = false;
          input.value = "";
        }
      }

      // âœ… Click + Enter support
      btn.addEventListener("click", sendMessage);
      input.addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendMessage();
      });
    </script>
  </body>
</html>
